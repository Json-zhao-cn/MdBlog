import{_ as a,c as o,a as s,b as t,e as r,w as l,r as i,o as c,d}from"./app-BCAoB5MR.js";const p="/MdBlog/assets/Jobs-DeWL77gP.png",u={};function h(g,e){const n=i("RouteLink");return c(),o("div",null,[e[1]||(e[1]=s('<h2 id="sync-job-status-in-the-sql-server-alwayson-cluster-solution" tabindex="-1"><a class="header-anchor" href="#sync-job-status-in-the-sql-server-alwayson-cluster-solution"><span><strong>Sync Job status in the SQL Server Alwayson cluster solution</strong></span></a></h2><h3 id="_1-scenario-requirement" tabindex="-1"><a class="header-anchor" href="#_1-scenario-requirement"><span>1. <strong>Scenario(<code>Requirement</code>)</strong></span></a></h3><p>In the SQL Server Availability Group(<code>AG</code>),when the AG changes failover,the primary server has become secondary server,in the meantime, the second server has become the primary server. In the master and slaver change roles.However, the CDC and other business jobs didn&#39;t register or run when the role changed. That&#39;s mean some businesses like PowerBI(<code>PB</code>) will stop, the sync data(<code>CDC</code>) will lose data. What should we do to stop this thing happened?</p><p><img src="'+p+`" alt="Jobs"></p><h3 id="_2-solution" tabindex="-1"><a class="header-anchor" href="#_2-solution"><span>2. <strong>Solution</strong></span></a></h3><p>We have two ways to prevent this thing happens.We have two options:</p><h4 id="_1-use-customer-stored-procedure-usp-checkserverrole-to-check-the-server-role-is-primary-or-not" tabindex="-1"><a class="header-anchor" href="#_1-use-customer-stored-procedure-usp-checkserverrole-to-check-the-server-role-is-primary-or-not"><span>1. Use customer stored procedure <code>Usp_CheckServerRole</code> to check the server role is primary or not.</span></a></h4><ul><li>Dupilcate all jobs in the all availability group.</li><li>Create the customer stored procedure <code>Usp_CheckServerRole</code></li></ul><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token keyword">SELECT</span> <span class="token number">1</span> </span>
<span class="line">    <span class="token keyword">FROM</span> sys<span class="token punctuation">.</span>dm_hadr_availability_replica_states rs</span>
<span class="line">    <span class="token keyword">JOIN</span> sys<span class="token punctuation">.</span>availability_replicas ar <span class="token keyword">ON</span> rs<span class="token punctuation">.</span>replica_id <span class="token operator">=</span> ar<span class="token punctuation">.</span>replica_id</span>
<span class="line">    <span class="token keyword">WHERE</span> rs<span class="token punctuation">.</span>is_local <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">AND</span> rs<span class="token punctuation">.</span>role_desc <span class="token operator">=</span> <span class="token string">&#39;PRIMARY&#39;</span></span>
<span class="line">    <span class="token operator">AND</span> ar<span class="token punctuation">.</span>replica_server_name <span class="token operator">=</span> @<span class="token variable">@SERVERNAME</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">BEGIN</span></span>
<span class="line">    <span class="token keyword">PRINT</span> <span class="token string">&#39;The current server is not primary server&#39;</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">RETURN</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">END</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>Each job step will add <code>Exec Usp_CheckServerRole</code> as first step</li><li>If the server is primary server, next, execute your business job.Otherwise,print error message.</li></ul><h4 id="_2-use-ag-trigger-ag-job-trigger-to-check-the-server-role-is-primary-or-not" tabindex="-1"><a class="header-anchor" href="#_2-use-ag-trigger-ag-job-trigger-to-check-the-server-role-is-primary-or-not"><span>2. Use AG Trigger <code>ag_job_trigger</code> to check the server role is primary or not.</span></a></h4>`,11)),t("ul",null,[t("li",null,[r(n,{to:"/blogs/Skills/SQLServer/Job/AGTriggerSyncJobStatus.html"},{default:l(()=>[...e[0]||(e[0]=[d("Using AG Trigger to Sync Job status in the SQL Server Alwayson cluster",-1)])]),_:1})])]),e[2]||(e[2]=s('<h3 id="_3-solution-compare" tabindex="-1"><a class="header-anchor" href="#_3-solution-compare"><span>3.<strong>Solution Compare</strong></span></a></h3><table><thead><tr><th>characteristic</th><th>Usp_CheckServerRole</th><th>ag_job_trigger</th></tr></thead><tbody><tr><td><strong>Solution complexity</strong></td><td>❌ <strong>complicated</strong> - add step when create each job step</td><td>✅ <strong>easy</strong> - create and maintain ag_job_trigger</td></tr><tr><td><strong>Job Role Management</strong></td><td>❌ <strong>manual</strong> - need to check each job status</td><td>✅ <strong>Automatic</strong> - Zero downtime for job handling</td></tr><tr><td><strong>SQL Agent Job History</strong></td><td>❌ <strong>noise</strong> - each job in the secondary server will generate useless history</td><td>✅ <strong>No Noise</strong> - no useless alter message</td></tr><tr><td><strong>Consistent Job State</strong></td><td>⚠️ <strong>Low</strong> - <br> • No job list<br> • No same enable/disable status<br>• Manual maintain job logic</td><td>✅ <strong>High</strong> <br> • The same job list<br> • The same enable/disable status<br>• The same logic</td></tr><tr><td><strong>CDC Job</strong></td><td>❌ <strong>low</strong> <br> Each server will execute job<br> Loss data <br>No failover recovery</td><td>✅ <strong>High</strong> <br> Ensures CDC capture jobs only run on the primary<br>Prevents CDC data loss caused by missing jobs on the new primary<br>Simplifies CDC failover recovery</td></tr><tr><td><strong>Safty</strong></td><td>• Each node will trigger job</td><td>• New primary automatically takes job workload<br>• Old primary automatically stops job workload</td></tr><tr><td><strong>Control</strong></td><td>Manual control</td><td>Centralized control</td></tr><tr><td><strong>Scales</strong></td><td>Less than Hundred jobs</td><td>Hundreds or Thousands of Jobs</td></tr><tr><td><strong>scenarios</strong></td><td>Development ,Test &amp; Small application</td><td>Enterprise</td></tr></tbody></table><h3 id="_4-summarize" tabindex="-1"><a class="header-anchor" href="#_4-summarize"><span>4.<strong>Summarize</strong></span></a></h3><p>Compare to use customer procedure<code>Usp_CheckServerRole</code>,<code>ag_job_trigger</code> is suit for the enterprise production environment.It has high scalability to control the job status, logic.The most importantly, when we use <code>CDC</code> service to sync data from source db to target db. We cannot tolerate the risk of data loss.So, we must use <code>ag_job_trigger</code> to control <code>CDC</code> jobs.This is mandtary, not optional.</p>',4))])}const b=a(u,[["render",h]]),v=JSON.parse('{"path":"/blogs/Skills/SQLServer/Job/SyncJobAG.html","title":"Sync Job status in the SQL Server Alwayson cluster solution","lang":"en-US","frontmatter":{"title":"Sync Job status in the SQL Server Alwayson cluster solution","date":"2025/11/21","tags":["SQLServer"],"categories":["Skills"]},"headers":[{"level":2,"title":"Sync Job status in the SQL Server Alwayson cluster solution","slug":"sync-job-status-in-the-sql-server-alwayson-cluster-solution","link":"#sync-job-status-in-the-sql-server-alwayson-cluster-solution","children":[{"level":3,"title":"1. Scenario(Requirement)","slug":"_1-scenario-requirement","link":"#_1-scenario-requirement","children":[]},{"level":3,"title":"2. Solution","slug":"_2-solution","link":"#_2-solution","children":[]},{"level":3,"title":"3.Solution Compare","slug":"_3-solution-compare","link":"#_3-solution-compare","children":[]},{"level":3,"title":"4.Summarize","slug":"_4-summarize","link":"#_4-summarize","children":[]}]}],"git":{"createdTime":1763986628000,"updatedTime":1763993056000,"contributors":[{"name":"json zhao","email":"json.zhao.cn@outlook.com","commits":1},{"name":"jsonzhao","email":"json.zhao.cn@outlook.com","commits":1}]},"filePathRelative":"blogs/Skills/SQLServer/Job/SyncJobAG.md"}');export{b as comp,v as data};
