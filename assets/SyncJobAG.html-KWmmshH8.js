import{_ as n,c as a,a as e,o as l}from"./app-DA3LR-qZ.js";const t="/MdBlog/assets/Jobs-DeWL77gP.png",o={};function i(r,s){return l(),a("div",null,[...s[0]||(s[0]=[e('<h2 id="sync-job-status-in-the-sql-server-alwayson-cluster-solution" tabindex="-1"><a class="header-anchor" href="#sync-job-status-in-the-sql-server-alwayson-cluster-solution"><span><strong>Sync Job status in the SQL Server Alwayson cluster solution</strong></span></a></h2><hr><h3 id="_1-scenario-requirement" tabindex="-1"><a class="header-anchor" href="#_1-scenario-requirement"><span>1. <strong>Scenario(<code>Requirement</code>)</strong></span></a></h3><p>In the SQL Server Availability Group(<code>AG</code>),when the AG changes failover,the primary server has become secondary server,in the meantime, the second server has become the primary server. In the master and slaver change roles.However, the CDC and other business jobs didn&#39;t register or run when the role changed. That&#39;s mean some businesses like PowerBI(<code>PB</code>) will stop, the sync data(<code>CDC</code>) will lose data. What should we do to stop this thing happened?</p><p><img src="'+t+`" alt="Jobs"></p><hr><h3 id="_2-solution" tabindex="-1"><a class="header-anchor" href="#_2-solution"><span>2. <strong>Solution</strong></span></a></h3><p>We have two ways to prevent this thing happens.We have two options:</p><h4 id="_1-use-customer-stored-procedure-dbo-usp-checkprimaryserver-to-check-the-server-role-is-primary-or-not" tabindex="-1"><a class="header-anchor" href="#_1-use-customer-stored-procedure-dbo-usp-checkprimaryserver-to-check-the-server-role-is-primary-or-not"><span>1. Use customer stored procedure <code>dbo.usp_CheckPrimaryServer</code> to check the server role is primary or not.</span></a></h4><ul><li>Dupilcate all jobs in the all availability group.</li><li>Create the customer stored procedure <code>dbo.usp_CheckPrimaryServer</code></li></ul><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> dbo<span class="token punctuation">.</span>usp_CheckPrimaryServer</span>
<span class="line"><span class="token keyword">AS</span></span>
<span class="line"><span class="token keyword">BEGIN</span></span>
<span class="line">    <span class="token keyword">SET</span> NOCOUNT <span class="token keyword">ON</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">DECLARE</span> <span class="token variable">@CurrentRole</span> NVARCHAR<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">SELECT</span> <span class="token variable">@CurrentRole</span> <span class="token operator">=</span> role_desc </span>
<span class="line">    <span class="token keyword">FROM</span> sys<span class="token punctuation">.</span>dm_hadr_availability_replica_states </span>
<span class="line">    <span class="token keyword">WHERE</span> is_local <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">IF</span> <span class="token variable">@CurrentRole</span> <span class="token operator">IS</span> <span class="token boolean">NULL</span> <span class="token operator">OR</span> <span class="token variable">@CurrentRole</span> <span class="token operator">&lt;&gt;</span> <span class="token string">&#39;PRIMARY&#39;</span></span>
<span class="line">    <span class="token keyword">BEGIN</span></span>
<span class="line">        <span class="token keyword">DECLARE</span> <span class="token variable">@Message</span> NVARCHAR<span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">SET</span> <span class="token variable">@Message</span> <span class="token operator">=</span> N<span class="token string">&#39;x  Current server is not PRIMARY server,stop job&#39;</span><span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">RAISERROR</span><span class="token punctuation">(</span><span class="token variable">@Message</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">RETURN</span> <span class="token number">1</span><span class="token punctuation">;</span> </span>
<span class="line">    <span class="token keyword">END</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">PRINT</span> N<span class="token string">&#39;✓ Current server is PRIMARY server，continue job&#39;</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">RETURN</span> <span class="token number">0</span><span class="token punctuation">;</span> </span>
<span class="line"><span class="token keyword">END</span></span>
<span class="line">GO</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-grant-user-access" tabindex="-1"><a class="header-anchor" href="#_2-grant-user-access"><span>2. grant user access</span></a></h4><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">USE</span> master<span class="token punctuation">;</span></span>
<span class="line">GO</span>
<span class="line"><span class="token comment">-- grant the user view STATE permission</span></span>
<span class="line"><span class="token keyword">GRANT</span> <span class="token keyword">VIEW</span> SERVER STATE <span class="token keyword">TO</span> <span class="token punctuation">[</span>YourUser<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">-- grant the user view permission</span></span>
<span class="line"><span class="token keyword">GRANT</span> <span class="token keyword">VIEW</span> <span class="token keyword">ANY</span> DEFINITION <span class="token keyword">TO</span> <span class="token punctuation">[</span>YourUser<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">GRANT</span> <span class="token keyword">VIEW</span> SERVER PERFORMANCE STATE <span class="token keyword">TO</span> <span class="token punctuation">[</span>YourUser<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>Each job step will add <code>Exec dbo.usp_CheckPrimaryServer</code> as first step</li><li>If the server is primary server, go to next step;otherwise,exit.</li></ul><hr><h3 id="_3-summarize" tabindex="-1"><a class="header-anchor" href="#_3-summarize"><span>3.<strong>Summarize</strong></span></a></h3><ol><li><p>Limitation</p><ul><li>It can&#39;t sovle the <code>CDC</code> job sync problem, the <code>MSDB</code> will loss some cdc element table;</li><li>Each job need add this step,it doesn&#39;t has central control;</li><li>Each job in the AG will generate some unuse messsage;</li></ul></li><li><p>Benefit</p><ul><li>Simple configurate. Less job is best way;</li></ul></li></ol>`,17)])])}const c=n(o,[["render",i]]),u=JSON.parse('{"path":"/blogs/Skills/SQLServer/Job/SyncJobAG.html","title":"Sync Job status in the SQL Server Alwayson cluster solution","lang":"en-US","frontmatter":{"title":"Sync Job status in the SQL Server Alwayson cluster solution","date":"2025/11/21","tags":["SQLServer"],"categories":["Skills"]},"headers":[{"level":2,"title":"Sync Job status in the SQL Server Alwayson cluster solution","slug":"sync-job-status-in-the-sql-server-alwayson-cluster-solution","link":"#sync-job-status-in-the-sql-server-alwayson-cluster-solution","children":[{"level":3,"title":"1. Scenario(Requirement)","slug":"_1-scenario-requirement","link":"#_1-scenario-requirement","children":[]},{"level":3,"title":"2. Solution","slug":"_2-solution","link":"#_2-solution","children":[]},{"level":3,"title":"3.Summarize","slug":"_3-summarize","link":"#_3-summarize","children":[]}]}],"git":{"createdTime":1763986628000,"updatedTime":1764579548000,"contributors":[{"name":"jsonzhao","email":"json.zhao.cn@outlook.com","commits":2},{"name":"json zhao","email":"json.zhao.cn@outlook.com","commits":1}]},"filePathRelative":"blogs/Skills/SQLServer/Job/SyncJobAG.md"}');export{c as comp,u as data};
