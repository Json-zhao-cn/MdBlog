import{_ as n,c as a,a as e,o as i}from"./app-BS8wjuLb.js";const t={};function l(p,s){return i(),a("div",null,[...s[0]||(s[0]=[e(`<h2 id="using-sql-to-get-db-server-user-and-session-info" tabindex="-1"><a class="header-anchor" href="#using-sql-to-get-db-server-user-and-session-info"><span><strong>Using SQL to get DB server user and session info</strong></span></a></h2><hr><h3 id="_1-get-current-session-acount" tabindex="-1"><a class="header-anchor" href="#_1-get-current-session-acount"><span>1. <strong>Get current session acount</strong></span></a></h3><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> CurrentSessionCount </span>
<span class="line"><span class="token keyword">FROM</span> sys<span class="token punctuation">.</span>dm_exec_sessions </span>
<span class="line"><span class="token keyword">WHERE</span> is_user_process <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h3 id="_2-get-current-db-connection-user-and-session" tabindex="-1"><a class="header-anchor" href="#_2-get-current-db-connection-user-and-session"><span>2. <strong>Get Current DB connection user and session</strong></span></a></h3><div class="language-SQL line-numbers-mode" data-highlighter="prismjs" data-ext="SQL" data-title="SQL"><pre><code><span class="line">-- Get Current DB connection user and session</span>
<span class="line">SELECT </span>
<span class="line">    session_id AS [Session ID],</span>
<span class="line">    login_name AS [Login Name],</span>
<span class="line">    host_name AS [Host Name],</span>
<span class="line">    program_name AS [Program Name],</span>
<span class="line">    status AS [Status],</span>
<span class="line">    cpu_time AS [CPU Time],</span>
<span class="line">    memory_usage AS [Memory Usage],</span>
<span class="line">    reads AS [Reads],</span>
<span class="line">    writes AS [Writes],</span>
<span class="line">    logical_reads AS [Logical Reads],</span>
<span class="line">    last_request_start_time AS [Last Request Start],</span>
<span class="line">    last_request_end_time AS [Last Request End]</span>
<span class="line">FROM sys.dm_exec_sessions</span>
<span class="line">WHERE is_user_process = 1  --Only display user processes and exclude system processes</span>
<span class="line">--and login_name=&#39;YourUser&#39; </span>
<span class="line">ORDER BY session_id;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h3 id="_3-get-current-db-connection-user-and-session" tabindex="-1"><a class="header-anchor" href="#_3-get-current-db-connection-user-and-session"><span>3. <strong>Get Current DB connection user and session</strong></span></a></h3><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">SELECT</span> </span>
<span class="line">    name <span class="token punctuation">,</span></span>
<span class="line">    <span class="token keyword">value</span> <span class="token punctuation">,</span></span>
<span class="line">    value_in_use <span class="token punctuation">,</span></span>
<span class="line">    description</span>
<span class="line"><span class="token keyword">FROM</span> sys<span class="token punctuation">.</span>configurations</span>
<span class="line"><span class="token keyword">WHERE</span> name <span class="token operator">=</span> <span class="token string">&#39;user connections&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h3 id="_4-check-session-configurate-limitation-and-current-usage" tabindex="-1"><a class="header-anchor" href="#_4-check-session-configurate-limitation-and-current-usage"><span>4. <strong>Check Session configurate limitation and current usage</strong></span></a></h3><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">DECLARE</span> <span class="token variable">@max_connections</span> <span class="token keyword">INT</span> <span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">DECLARE</span> <span class="token variable">@current_connections</span> <span class="token keyword">int</span><span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">SELECT</span>  <span class="token variable">@max_connections</span><span class="token operator">=</span><span class="token keyword">CONVERT</span><span class="token punctuation">(</span><span class="token keyword">INT</span><span class="token punctuation">,</span>value_in_use <span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">FROM</span> sys<span class="token punctuation">.</span>configurations </span>
<span class="line"><span class="token keyword">WHERE</span> name <span class="token operator">=</span> <span class="token string">&#39;user connections&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">SELECT</span>  <span class="token variable">@current_connections</span><span class="token operator">=</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> </span>
<span class="line"><span class="token keyword">FROM</span> sys<span class="token punctuation">.</span>dm_exec_sessions </span>
<span class="line"><span class="token keyword">WHERE</span> is_user_process <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">SELECT</span> </span>
<span class="line">    <span class="token variable">@max_connections</span> <span class="token punctuation">,</span></span>
<span class="line">    <span class="token variable">@current_connections</span><span class="token punctuation">,</span></span>
<span class="line">    CAST<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">@current_connections</span> <span class="token operator">*</span> <span class="token number">100.0</span> <span class="token operator">/</span> <span class="token keyword">NULLIF</span><span class="token punctuation">(</span><span class="token variable">@max_connections</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> rate<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h3 id="_5-query-possible-problem-sessions" tabindex="-1"><a class="header-anchor" href="#_5-query-possible-problem-sessions"><span>5. <strong>Query possible problem sessions</strong></span></a></h3><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token comment">-- Query possible problem sessions (blocked/long-running)</span></span>
<span class="line"><span class="token keyword">SELECT</span> </span>
<span class="line">    s<span class="token punctuation">.</span>session_id<span class="token punctuation">,</span></span>
<span class="line">    r<span class="token punctuation">.</span><span class="token keyword">status</span><span class="token punctuation">,</span></span>
<span class="line">    r<span class="token punctuation">.</span>blocking_session_id<span class="token punctuation">,</span></span>
<span class="line">    r<span class="token punctuation">.</span>wait_type<span class="token punctuation">,</span></span>
<span class="line">    r<span class="token punctuation">.</span>wait_time<span class="token punctuation">,</span></span>
<span class="line">    r<span class="token punctuation">.</span>wait_resource<span class="token punctuation">,</span></span>
<span class="line">    r<span class="token punctuation">.</span>cpu_time<span class="token punctuation">,</span></span>
<span class="line">    r<span class="token punctuation">.</span>logical_reads<span class="token punctuation">,</span></span>
<span class="line">    r<span class="token punctuation">.</span><span class="token keyword">reads</span><span class="token punctuation">,</span></span>
<span class="line">    r<span class="token punctuation">.</span>writes<span class="token punctuation">,</span></span>
<span class="line">    s<span class="token punctuation">.</span>login_name<span class="token punctuation">,</span></span>
<span class="line">    s<span class="token punctuation">.</span>host_name<span class="token punctuation">,</span></span>
<span class="line">    s<span class="token punctuation">.</span>program_name<span class="token punctuation">,</span></span>
<span class="line">    t<span class="token punctuation">.</span><span class="token keyword">text</span> <span class="token keyword">AS</span> sqlTest<span class="token punctuation">,</span></span>
<span class="line">    qp<span class="token punctuation">.</span>query_plan <span class="token keyword">AS</span> exeplan</span>
<span class="line"><span class="token keyword">FROM</span> sys<span class="token punctuation">.</span>dm_exec_sessions s</span>
<span class="line"><span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> sys<span class="token punctuation">.</span>dm_exec_requests r <span class="token keyword">ON</span> s<span class="token punctuation">.</span>session_id <span class="token operator">=</span> r<span class="token punctuation">.</span>session_id</span>
<span class="line"><span class="token keyword">OUTER</span> <span class="token keyword">APPLY</span> sys<span class="token punctuation">.</span>dm_exec_sql_text<span class="token punctuation">(</span>r<span class="token punctuation">.</span>sql_handle<span class="token punctuation">)</span> t</span>
<span class="line"><span class="token keyword">OUTER</span> <span class="token keyword">APPLY</span> sys<span class="token punctuation">.</span>dm_exec_query_plan<span class="token punctuation">(</span>r<span class="token punctuation">.</span>plan_handle<span class="token punctuation">)</span> qp</span>
<span class="line"><span class="token keyword">WHERE</span> s<span class="token punctuation">.</span>is_user_process <span class="token operator">=</span> <span class="token number">1</span></span>
<span class="line"><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> r<span class="token punctuation">.</span>cpu_time <span class="token keyword">DESC</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h3 id="_6-change-session-configuration-restart-sql-server-service" tabindex="-1"><a class="header-anchor" href="#_6-change-session-configuration-restart-sql-server-service"><span>6. <strong>change session configuration <em><strong><code>restart sql server service</code></strong></em></strong></span></a></h3><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token comment">-- Modify the maximum number of user connections (SA permission required)</span></span>
<span class="line"><span class="token comment">-- set as 0 mean no limitation(not recommend)</span></span>
<span class="line"><span class="token keyword">EXEC</span> sp_configure <span class="token string">&#39;show advanced options&#39;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">RECONFIGURE</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">EXEC</span> sp_configure <span class="token string">&#39;user connections&#39;</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">;</span> <span class="token comment">--  set as 500</span></span>
<span class="line"><span class="token keyword">RECONFIGURE</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,19)])])}const c=n(t,[["render",l]]),r=JSON.parse('{"path":"/blogs/Skills/SQLServer/UserAndSession/GetServerSessionAndUserInfo.html","title":"Using SQL to get DB server user and session info","lang":"en-US","frontmatter":{"title":"Using SQL to get DB server user and session info","date":"2025/11/26","tags":["SQLServer"],"categories":["Skills"]},"headers":[{"level":2,"title":"Using SQL to get DB server user and session info","slug":"using-sql-to-get-db-server-user-and-session-info","link":"#using-sql-to-get-db-server-user-and-session-info","children":[{"level":3,"title":"1. Get current session acount","slug":"_1-get-current-session-acount","link":"#_1-get-current-session-acount","children":[]},{"level":3,"title":"2. Get Current DB connection user and session","slug":"_2-get-current-db-connection-user-and-session","link":"#_2-get-current-db-connection-user-and-session","children":[]},{"level":3,"title":"3. Get Current DB connection user and session","slug":"_3-get-current-db-connection-user-and-session","link":"#_3-get-current-db-connection-user-and-session","children":[]},{"level":3,"title":"4. Check Session configurate limitation and current usage","slug":"_4-check-session-configurate-limitation-and-current-usage","link":"#_4-check-session-configurate-limitation-and-current-usage","children":[]},{"level":3,"title":"5. Query possible problem sessions","slug":"_5-query-possible-problem-sessions","link":"#_5-query-possible-problem-sessions","children":[]},{"level":3,"title":"6. change session configuration restart sql server service","slug":"_6-change-session-configuration-restart-sql-server-service","link":"#_6-change-session-configuration-restart-sql-server-service","children":[]}]}],"git":{"createdTime":1764135587000,"updatedTime":1764297319000,"contributors":[{"name":"jsonzhao","email":"json.zhao.cn@outlook.com","commits":2}]},"filePathRelative":"blogs/Skills/SQLServer/UserAndSession/GetServerSessionAndUserInfo.md"}');export{c as comp,r as data};
